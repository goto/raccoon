"use strict";(self.webpackChunkfirehose=self.webpackChunkfirehose||[]).push([[119],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return d}});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(t),d=o,g=m["".concat(l,".").concat(d)]||m[d]||u[d]||r;return t?a.createElement(g,i(i({ref:n},p),{},{components:t})):a.createElement(g,i({ref:n},p))}));function d(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,i=new Array(r);i[0]=m;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=t[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},5667:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return u}});var a=t(7462),o=t(3366),r=(t(7294),t(3905)),i=["components"],s={},l="Deployment",c={unversionedId:"guides/deployment",id:"guides/deployment",title:"Deployment",description:"This section contains guides and suggestions related to Raccoon deployment.",source:"@site/docs/guides/deployment.md",sourceDirName:"guides",slug:"/guides/deployment",permalink:"/raccoon/guides/deployment",draft:!1,editUrl:"https://github.com/goto/raccoon/edit/master/docs/docs/guides/deployment.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Publishing Events",permalink:"/raccoon/guides/publishing"},next:{title:"Monitoring",permalink:"/raccoon/guides/monitoring"}},p={},u=[{value:"Kubernetes",id:"kubernetes",level:2},{value:"Manifest",id:"manifest",level:3},{value:"Helm",id:"helm",level:3},{value:"Production Checklist",id:"production-checklist",level:2},{value:"Key Configurations",id:"key-configurations",level:3}],m={toc:u};function d(e){var n=e.components,t=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"deployment"},"Deployment"),(0,r.kt)("p",null,"This section contains guides and suggestions related to Raccoon deployment."),(0,r.kt)("h2",{id:"kubernetes"},"Kubernetes"),(0,r.kt)("p",null,"Using ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/goto/raccoon"},"Raccoon docker image"),", you can deploy Raccoon on ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/"},"Kubernetes")," by specifying the image on the ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment"},"manifest"),". We also provide ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/goto/charts/tree/main/stable/raccoon"},"Helm chart")," to ease Kubernetes deployment. In this section we will cover simple deployment on Kubernetes using manifest and Helm."),(0,r.kt)("h3",{id:"manifest"},"Manifest"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Prerequisite")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Kubernetes cluster setup"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/#kubectl"},"Kubectl")," installed")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Creating Kubernetes Resources")," You need at least 2 manifests for Raccoon. For ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment"},"deployment")," and for ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/"},"configmap"),". Prepare both manifest as YAML file. You can fill in the configuration as needed."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"configmap.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: raccoon-config\n  namespace: default\n  labels:\n    application: raccoon\ndata:\n  METRIC_STATSD_ADDRESS: "host.docker.internal:8125"\n  PUBLISHER_KAFKA_CLIENT_BOOTSTRAP_SERVERS: "host.docker.internal:9093"\n  SERVER_WEBSOCKET_CONN_ID_HEADER: "X-User-ID"\n  SERVER_WEBSOCKET_PORT: "8080"\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"deployment.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: raccoon\n  labels:\n    application: raccoon\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      application: raccoon\n  template:\n    metadata:\n      labels:\n        application: raccoon\n    spec:\n      containers:\n      - name: raccoon\n        image: "gotocompany/raccoon:latest"\n        imagePullPolicy: IfNotPresent\n        resources:\n            limits:\n              cpu: 200m\n              memory: 512Mi\n            requests:\n              cpu: 200m\n              memory: 512Mi\n        envFrom:\n          - configMapRef:\n              name: raccoon-config\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: NODE_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: spec.nodeName\n      volumes:\n')),(0,r.kt)("p",null,"Suppose you save them as ",(0,r.kt)("inlineCode",{parentName:"p"},"configmap.yaml")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment.yaml"),". The next step is to apply the manifests to the Kubeenetes cluster using ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl")," command."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl apply -f configmap.yaml -f deployment.yaml\n")),(0,r.kt)("p",null,"You'll find the resources are created. To see the status of the deployment, you can run following commands."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Check deployment status\n$ kubectl get deployment raccoon\n# Check configmap status\n$ kubectl get configmap raccoon-config\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Configuration")," You can add or modify the configurations inside ",(0,r.kt)("inlineCode",{parentName:"p"},"configmap.yaml")," above. However, when you change the configmap, you also need to restart the deployment."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Exposing Raccoon")," To make Raccoon accessible to the public, you need to setup the Kubernetes ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/service/"},"service")," and ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/ingress/"},"ingress"),". This setup may vary according to your need. There is plenty ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/"},"ingress controller")," you can choose. But first, you need to make sure that Websocket works with your choice of ingress controller."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Integrating With Telegraf")," There are 2 options to integrate with Telegraf. One is to have Telegraf as separate service another is to have Telegraf as a sidecar. To have telegraf as a sidecar, you only need to add another configmap and another Telegraf container on the deployment above. You can add the container under ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.template.spec.containers"),". Then, you can use default ",(0,r.kt)("inlineCode",{parentName:"p"},"METRIC_STATSD_ADDRESS")," which is ",(0,r.kt)("inlineCode",{parentName:"p"},":8125"),". Following is an example of Telegraf manifests that push to Influxdb."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"deployment.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"...\n      containers:\n      - image: telegraf:1.7.4-alpine\n        imagePullPolicy: IfNotPresent\n        name: telegrafd\n        resources:\n          limits:\n            cpu: 50m\n            memory: 64Mi\n          requests:\n            cpu: 50m\n            memory: 64Mi\n        volumeMounts:\n        - mountPath: /etc/telegraf\n          name: telegraf-conf\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: test-raccoon-telegraf-config\n        name: telegraf-conf  \n...\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"telegraf-conf.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: telegraf-conf\n  namespace: default\ndata:\n  telegraf.conf: |\n    [global_tags]\n      app = "test-raccoon"\n    [agent]\n      collection_jitter = "0s"\n      debug = false\n      flush_interval = "10s"\n      flush_jitter = "0s"\n      interval = "10s"\n      logfile = ""\n      metric_batch_size = 1000\n      metric_buffer_limit = 10000\n      omit_hostname = false\n      precision = ""\n      quiet = false\n      round_interval = true\n    [[outputs.influxdb]]\n      urls = ["http://localhost:8086"]\n      database = "test-db"\n      retention_policy = "autogen"\n      write_consistency = "any"\n      timeout = "5s"\n    [[inputs.statsd]]\n      allowed_pending_messages = 10000\n      delete_counters = true\n      delete_gauges = true\n      delete_sets = true\n      delete_timings = true\n      metric_separator = "."\n      parse_data_dog_tags = true\n      percentile_limit = 1000\n      percentiles = [\n        50,\n        95,\n        99\n      ]\n      service_address = ":8125"\n')),(0,r.kt)("h3",{id:"helm"},"Helm"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Prerequisite")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Kubernetes cluster setup"),(0,r.kt)("li",{parentName:"ul"},"Helm installed")),(0,r.kt)("p",null,"Raccoon has a Helm chart maintained on ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/goto/charts/tree/main/stable/raccoon"},"different repository"),". Refer to the repository for a complete deployment guide."),(0,r.kt)("h2",{id:"production-checklist"},"Production Checklist"),(0,r.kt)("p",null,"Before going to production, we recommend the following setup tips."),(0,r.kt)("h3",{id:"key-configurations"},"Key Configurations"),(0,r.kt)("p",null,"Followings are main configurations closely related to deployment that you need to pay attention:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/reference/configurations#server_websocket_port"},(0,r.kt)("inlineCode",{parentName:"a"},"SERVER_WEBSOCKET_PORT")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/reference/configurations#event_distribution_publisher_pattern"},(0,r.kt)("inlineCode",{parentName:"a"},"EVENT_DISTRIBUTION_PUBLISHER_PATTERN")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/reference/configurations#publisher_kafka_client_bootstrap_servers"},(0,r.kt)("inlineCode",{parentName:"a"},"PUBLISHER_KAFKA_CLIENT_BOOTSTRAP_SERVERS")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/reference/configurations#metric_statsd_address"},(0,r.kt)("inlineCode",{parentName:"a"},"METRIC_STATSD_ADDRESS")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/reference/configurations#server_websocket_conn_id_header"},(0,r.kt)("inlineCode",{parentName:"a"},"SERVER_WEBSOCKET_CONN_ID_HEADER"))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"TLS/HTTPS")),(0,r.kt)("p",{parentName:"li"},"Raccoon doesn't provide HTTPS on the application level. To enable HTTPS, you can maintain API gateway which terminates SSL connection. From API gateway onward, the connection is considered to be safe. For example, if you are deploying on Kubernetes, you can have an ingress setup and have SSL termination."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Authentication")),(0,r.kt)("p",{parentName:"li"},"Raccoon doesn't provide authentication on its own. However, you can still enable authentication by having it as a separate service. Then, you can use an API gateway to validate the authentication using a token."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Test The Setup")),(0,r.kt)("p",{parentName:"li"},"To make sure the deployment can handle the load, you need to test it with the same number of connections and request you are expecting. You can find a guide on how to publish events ",(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/guides/publishing"},"here"),". You can also check example client ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/goto/raccoon/tree/main/docs/example"},"here"),". If there is something wrong with Raccon, you can check the ",(0,r.kt)("a",{parentName:"p",href:"https://goto.gitbook.io/raccoon/guides/troubleshooting"},"troubleshooting")," section."))))}d.isMDXComponent=!0}}]);